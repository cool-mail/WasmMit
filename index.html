<!DOCTYPE html>
<html lang=en-us>
<head>
    <meta charset=utf-8>
    <meta content="text/html; charset=utf-8" http-equiv=Content-Type>
    <link rel="shortcut icon" href="favicon.png" type="image/png" />
    <style type="text/css">
       * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        button {

        }

        ul {
            list-style: none;
        }

        body {
            font-family: sans-serif;
        }


        nav {
            height: 100vh;
            background-color: dodgerblue;
            width: 200px;
            padding: 10px;
            transform: translateX(200px);
            transition: transform .5s ease-in-out;
            float:left;
        }

            nav.active {
                transform: translateX(0);
            }

            nav .logo {
                margin: 10px 0 20px;
                color: white;
                font-weight: 700;
                font-size: larger;                
            }

            nav ul li {
                padding: 10px;
                font-weight: 500;
                
            }

                nav ul li button {
                    text-decoration: none;
                    border: 0 none;
                    background: none;
                    color: #fff;
                    transition: all .2s ease;
                    font-size: medium;
                }

                    nav ul li button:hover {
                        background-color: #fff;
                        color: dodgerblue;
                        padding-left: 10px;
                    }

                    nav ul li button:active {
                        background-color: #fff;
                        color: dodgerblue;
                        padding: 10px;
                    }

        canvas {
            border: 0 none;
        }

        figure {
            overflow: visible;
            height: 100%;
            width: 100%;            
            position: absolute;
            justify-content: center;
            align-items: center;
        }

        div#mainBlock {
            width: 100%;
            height: 100%;
            white-space: nowrap;
            overflow: hidden
        }

    </style>
    <title>Пример</title>
</head>
<body>
    <figure id="preloaderBlock" style="display: flex;">
        <center style="margin-top:1.5em; line-height:150%">
            <strong> Загрузка программы просмотра </strong>
            <noscript> JavaScript is disabled. Please enable JavaScript to use this application. </noscript>
        </center>
    </figure>

    <figure id="errorBlock" style="display: none;">
        <center style="margin-top:1.5em; line-height:150%">
            <strong id="errorMsg"> Внутреняя ошибка программы просмотра. Сообщите разработчикам и воспользуйтесь сервисом позднее </strong>
        </center>
    </figure>

    <div id="mainBlock" style="display:none;">
        <nav class="active">
            <div class="logo">
                Действия
            </div>
            <ul>
                <li><button onclick="self.MyViewer.createSectionPlaneByLevelId('3SV3DKf65A28IpPmY9Uc79')">Отсечь по 1-ый этаж</button></li>
                <li><button onclick="self.MyViewer.createSectionPlaneByLevelId('3SV3DKf65A28IpPmY9UcT_')">Отсечь по 2-ой этаж</button></li>
                <li><button onclick="self.MyViewer.highlightErrors()">Найти ошибки</button></li>
                <li><button onclick="self.MyViewer.highlightMaterialOverUsage()">Перерасход бетона</button></li>
                <li><button onclick="self.MyViewer.highlightBuildingStatus()">Статус строительства</button></li>
                <li><button onclick="self.MyViewer.createSectionBox()">Секущий куб</button></li>
                <li><button onclick="self.MyViewer.resetToDefaultState()">Перезагрузить</button></li>
            </ul>
        </nav>

        <canvas id="canvas" oncontextmenu="event.preventDefault()" tabindex=-1></canvas>
    </div>


    <script type="module" charset="utf-8">
        import MyViewer from './MyViewer.js';

        function isWasmSupported() {
            try {
                if (typeof WebAssembly === "object"
                    && typeof WebAssembly.instantiate === "function") {
                    const aDummyModule = new WebAssembly.Module(Uint8Array.of(0x0, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00));
                    if (aDummyModule instanceof WebAssembly.Module) {
                        return new WebAssembly.Instance(aDummyModule) instanceof WebAssembly.Instance;
                    }
                }
            } catch (e) { }
            return false;
        }

        async function initViewer() {
            try {
                var preloaderBlock = document.querySelector('#preloaderBlock');
                var errorBlock = document.querySelector('#errorBlock');
                var canvas = document.querySelector('#canvas');
                var mainBlock = document.querySelector('#mainBlock');
                

                if (!isWasmSupported()) {
                    var errorMsg = document.querySelector('#errorMsg');
                    errorMsg.textContent = "Ваш браузер не поддерживает технологию WebAssembly, либо она выключена в настройках браузера. Обновите браузер либо перезайдите на страницу с помощью другого браузера. Запрет работы JavaScript также может быть причиной неполадок";
                    throw new Error("WebAssembly is not supported");
                }

                function updateCanvasSize() {
                    var canvas = document.getElementById('canvas');

                    var aSizeX = Math.min(window.innerWidth, window.screen.availWidth);
                    var aSizeY = Math.min(window.innerHeight, window.screen.availHeight);
                    aSizeX = Math.max(300, aSizeX - 30);
                    aSizeY = Math.max(300, aSizeY - 30); 
                    canvas.style.width = "100%";
                    canvas.style.height = "100vh";

                    var aDevicePixelRatio = window.devicePixelRatio || 1;
                    canvas.width = aSizeX * aDevicePixelRatio;
                    canvas.height = aSizeY * aDevicePixelRatio;

                }

                window.onresize = updateCanvasSize;


                self.MyViewer = await new MyViewer({
                    canvas: canvas
                });

                preloaderBlock.style.display = 'none';
                errorBlock.style.display = 'none'
                mainBlock.style.display = 'block'
                                
                updateCanvasSize();

                self.MyViewer.startViewer();
                
            }
            catch (e) {
                console.error(e);
                console.error(e.stack);

                preloaderBlock.style.display = 'none';
                errorBlock.style.display = 'flex';
                mainBlock.style.display = 'none';
            }
        }

        initViewer();

    </script>
</body>
</html>
